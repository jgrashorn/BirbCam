{% extends "base.html" %}

{% block title %}Settings - {{ cam }} - BirbCam{% endblock %}

{% block page_class %}settings-page{% endblock %}

{% block head_extra %}
<style>
.settings-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.settings-form {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: var(--text-primary);
}

.form-group input, .form-group select {
    width: 100%;
    max-width: 300px;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
}

.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: var(--accent-color);
}

.form-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--text-primary);
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn-primary {
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-primary:hover {
    background: var(--accent-color-dark);
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-secondary:hover {
    background: var(--bg-quaternary);
}

.error-message {
    background: #ff4444;
    color: white;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.success-message {
    background: #44ff44;
    color: #000;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-online {
    background: #44ff44;
}

.status-offline {
    background: #ff4444;
}

.help-text {
    font-size: 0.9em;
    color: var(--text-secondary);
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <h1>
        <span id="connection-status" class="status-indicator status-offline"></span>
        Camera Settings - {{ cam }}
    </h1>
    
    {% if error %}
    <div class="error-message">
        {{ error }}
    </div>
    {% endif %}
    
    <div id="message-container"></div>
    
    <form id="settings-form" class="settings-form">
        
        <div class="form-section">
            <h3>Video Settings</h3>
            
            <div class="form-group">
                <label for="resolution">Video Resolution:</label>
                <select id="resolution" name="resolution" required>
                    <option value="1296x972" {% if config.get('width', 1296) == 1296 and config.get('height', 972) == 972 %}selected{% endif %}>1296x972 (Standard)</option>
                    <option value="1920x1080" {% if config.get('width', 1296) == 1920 and config.get('height', 972) == 1080 %}selected{% endif %}>1920x1080 (Full HD)</option>
                </select>
                <div class="help-text">Recording resolution (width x height)</div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Color & Light Settings</h3>
            
            <div class="form-group">
                <label for="bwSwitchingSensitivity">B/W Switching Sensitivity:</label>
                <input type="number" id="bwSwitchingSensitivity" name="bwSwitchingSensitivity" value="{{ config.get('bwSwitchingSensitivity', 1500) }}" min="0" max="10000" step="100">
                <div class="help-text">Brightness threshold for switching to grayscale (lower = switches earlier)</div>
            </div>
            
            <div class="form-group">
                <label for="clrSwitchingSensitivity">Color Switching Sensitivity:</label>
                <input type="number" id="clrSwitchingSensitivity" name="clrSwitchingSensitivity" value="{{ config.get('clrSwitchingSensitivity', 1800) }}" min="0" max="10000" step="100">
                <div class="help-text">Brightness threshold for switching to color (higher = switches later)</div>
            </div>
            
            <div class="form-group">
                <label for="colorOffset_red">Color Offset Red:</label>
                <input type="number" id="colorOffset_red" name="colorOffset_red" value="{{ config.get('colorOffset_red', 0.8) }}" min="0.1" max="3.0" step="0.1">
                <div class="help-text">Red color correction for IR cameras</div>
            </div>
            
            <div class="form-group">
                <label for="colorOffset_blue">Color Offset Blue:</label>
                <input type="number" id="colorOffset_blue" name="colorOffset_blue" value="{{ config.get('colorOffset_blue', 1.5) }}" min="0.1" max="3.0" step="0.1">
                <div class="help-text">Blue color correction for IR cameras</div>
            </div>
            
            <div class="form-group">
                <label for="skippedFramesAfterChange">Skipped Frames After Change:</label>
                <input type="number" id="skippedFramesAfterChange" name="skippedFramesAfterChange" value="{{ config.get('skippedFramesAfterChange', 50) }}" min="1" max="200">
                <div class="help-text">Number of frames to skip after mode changes</div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Audio Settings</h3>
            
            <div class="form-group">
                <label for="audioDelay">Audio Delay (seconds):</label>
                <input type="number" id="audioDelay" name="audioDelay" value="{{ config.get('audioDelay', -0.3) }}" min="-2.0" max="2.0" step="0.1">
                <div class="help-text">Audio synchronization delay</div>
            </div>
        </div>
        
        <div class="button-group">
            <button type="submit" class="btn-primary">Save Settings</button>
            <button type="button" id="reload-btn" class="btn-secondary">Reload from Camera</button>
            <button type="button" id="ping-btn" class="btn-secondary">Test Connection</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let cam = '{{ cam }}';

function showMessage(text, type = 'info') {
    const container = document.getElementById('message-container');
    const div = document.createElement('div');
    div.className = type === 'error' ? 'error-message' : 'success-message';
    div.textContent = text;
    container.innerHTML = '';
    container.appendChild(div);
    
    setTimeout(() => {
        if (container.contains(div)) {
            container.removeChild(div);
        }
    }, 5000);
}

function updateConnectionStatus(online) {
    const indicator = document.getElementById('connection-status');
    indicator.className = 'status-indicator ' + (online ? 'status-online' : 'status-offline');
}

function collectFormData() {
    const form = document.getElementById('settings-form');
    const formData = new FormData(form);
    const config = {};
    
    for (let [key, value] of formData.entries()) {
        // Handle resolution dropdown
        if (key === 'resolution') {
            const [width, height] = value.split('x').map(v => parseInt(v));
            config['width'] = width;
            config['height'] = height;
        }
        // Convert numeric values
        else if (['rtspPort', 'settingsPort', 'bwSwitchingSensitivity', 
             'clrSwitchingSensitivity', 'skippedFramesAfterChange'].includes(key)) {
            config[key] = parseInt(value);
        } else if (['colorOffset_red', 'colorOffset_blue', 'audioDelay'].includes(key)) {
            config[key] = parseFloat(value);
        } else {
            config[key] = value;
        }
    }
    
    return config;
}

function loadSettings() {
    fetch(`/api/settings/${cam}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok' && data.config) {
                const config = data.config;
                // Populate form fields
                Object.keys(config).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = config[key];
                    }
                });
                // Set resolution dropdown based on width and height
                if (config.width && config.height) {
                    const resolutionSelect = document.getElementById('resolution');
                    if (resolutionSelect) {
                        resolutionSelect.value = `${config.width}x${config.height}`;
                    }
                }
                updateConnectionStatus(true);
                showMessage('Settings loaded successfully', 'success');
            } else {
                updateConnectionStatus(false);
                showMessage(data.message || 'Failed to load settings', 'error');
            }
        })
        .catch(error => {
            updateConnectionStatus(false);
            showMessage('Connection error: ' + error.message, 'error');
        });
}

function saveSettings() {
    const config = collectFormData();
    
    fetch(`/api/settings/${cam}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            updateConnectionStatus(true);
            showMessage('Settings saved successfully', 'success');
        } else {
            showMessage(data.message || 'Failed to save settings', 'error');
        }
    })
    .catch(error => {
        updateConnectionStatus(false);
        showMessage('Connection error: ' + error.message, 'error');
    });
}

function pingCamera() {
    fetch(`/api/ping/${cam}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                updateConnectionStatus(true);
                showMessage('Camera is online', 'success');
            } else {
                updateConnectionStatus(false);
                showMessage(data.message || 'Camera not responding', 'error');
            }
        })
        .catch(error => {
            updateConnectionStatus(false);
            showMessage('Connection error: ' + error.message, 'error');
        });
}

// Event listeners
document.getElementById('settings-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings();
});

document.getElementById('reload-btn').addEventListener('click', function() {
    loadSettings();
});

document.getElementById('ping-btn').addEventListener('click', function() {
    pingCamera();
});

// Initial connection test
pingCamera();
</script>
{% endblock %}