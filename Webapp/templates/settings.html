{% extends "base.html" %}

{% block title %}Settings - {{ cam }} - BirbCam{% endblock %}

{% block page_class %}settings-page{% endblock %}

{% block head_extra %}
<style>
.settings-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.settings-form {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: var(--text-primary);
}

.form-group input, .form-group select {
    width: 100%;
    max-width: 300px;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
}

.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: var(--accent-color);
}

.form-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--text-primary);
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn-primary {
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-primary:hover {
    background: var(--accent-color-dark);
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-secondary:hover {
    background: var(--bg-quaternary);
}

.error-message {
    background: #ff4444;
    color: white;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.success-message {
    background: #44ff44;
    color: #000;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-online {
    background: #44ff44;
}

.status-offline {
    background: #ff4444;
}

.help-text {
    font-size: 0.9em;
    color: var(--text-secondary);
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <h1>
        <span id="connection-status" class="status-indicator status-offline"></span>
        Camera Settings - {{ cam }}
        {% if camera_type %}
        <span style="font-size: 0.6em; color: var(--text-secondary);">({{ camera_type }})</span>
        {% endif %}
    </h1>
    
    {% if error %}
    <div class="error-message">
        {{ error }}
    </div>
    {% endif %}
    
    <div id="message-container"></div>
    
    <form id="settings-form" class="settings-form">
        {% if settings %}
            {% for setting_name, setting_meta in settings.items() %}
            {% if not setting_meta.get('hidden', False) %}
            <div class="form-group">
                <label for="{{ setting_name }}">
                    {{ setting_meta.label }}:
                </label>
                
                {% if setting_meta.type == 'boolean' %}
                    <input type="checkbox" 
                           id="{{ setting_name }}" 
                           name="{{ setting_name }}"
                           {% if setting_meta.current_value %}checked{% endif %}>
                
                {% elif setting_meta.type == 'select' %}
                    <select id="{{ setting_name }}" name="{{ setting_name }}">
                        {% for option in setting_meta.options %}
                        {% if option is mapping %}
                        {# Option is a dict with value and label #}
                        <option value="{{ option.value }}" 
                                {% if option.value == setting_meta.current_value %}selected{% endif %}>
                            {{ option.label }}
                        </option>
                        {% else %}
                        {# Option is a simple value #}
                        <option value="{{ option }}" 
                                {% if option == setting_meta.current_value %}selected{% endif %}>
                            {{ option }}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                
                {% elif setting_meta.type == 'number' %}
                    <input type="number" 
                           id="{{ setting_name }}" 
                           name="{{ setting_name }}"
                           value="{{ setting_meta.current_value }}"
                           {% if setting_meta.min is defined %}min="{{ setting_meta.min }}"{% endif %}
                           {% if setting_meta.max is defined %}max="{{ setting_meta.max }}"{% endif %}
                           {% if setting_meta.step is defined %}step="{{ setting_meta.step }}"{% endif %}>
                
                {% else %}
                    <input type="text" 
                           id="{{ setting_name }}" 
                           name="{{ setting_name }}"
                           value="{{ setting_meta.current_value }}">
                {% endif %}
                
                {% if setting_meta.description %}
                <div class="help-text">{{ setting_meta.description }}</div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        {% else %}
            <p>No settings available or unable to connect to camera.</p>
        {% endif %}
        
        <div class="button-group">
            <button type="submit" class="btn-primary">Save Settings</button>
            <button type="button" id="reload-btn" class="btn-secondary">Reload from Camera</button>
            <button type="button" id="ping-btn" class="btn-secondary">Test Connection</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let cam = '{{ cam }}';

function showMessage(text, type = 'info') {
    const container = document.getElementById('message-container');
    const div = document.createElement('div');
    div.className = type === 'error' ? 'error-message' : 'success-message';
    div.textContent = text;
    container.innerHTML = '';
    container.appendChild(div);
    
    setTimeout(() => {
        if (container.contains(div)) {
            container.removeChild(div);
        }
    }, 5000);
}

function updateConnectionStatus(online) {
    const indicator = document.getElementById('connection-status');
    indicator.className = 'status-indicator ' + (online ? 'status-online' : 'status-offline');
}

function collectFormData() {
    const form = document.getElementById('settings-form');
    const formData = new FormData(form);
    const config = {};
    
    for (let [key, value] of formData.entries()) {
        const input = document.getElementById(key);
        
        // Handle checkboxes
        if (input && input.type === 'checkbox') {
            config[key] = input.checked;
        }
        // Handle numbers
        else if (input && input.type === 'number') {
            const num = parseFloat(value);
            // Use integer if step is 1 or not defined, otherwise use float
            config[key] = (input.step && parseFloat(input.step) < 1) ? num : parseInt(value);
        }
        // Everything else as string
        else {
            config[key] = value;
        }
    }
    
    return config;
}

function loadSettings() {
    fetch(`/api/settings/${cam}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok' && data.data) {
                const settings = data.data.settings;
                
                // Populate form fields dynamically
                Object.keys(settings).forEach(key => {
                    const input = document.getElementById(key);
                    const meta = settings[key];
                    
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = meta.current_value;
                        } else {
                            input.value = meta.current_value;
                        }
                    }
                });
                
                updateConnectionStatus(true);
                showMessage('Settings loaded successfully', 'success');
            } else {
                updateConnectionStatus(false);
                showMessage(data.message || 'Failed to load settings', 'error');
            }
        })
        .catch(error => {
            updateConnectionStatus(false);
            showMessage('Connection error: ' + error.message, 'error');
        });
}

function saveSettings() {
    const config = collectFormData();
    
    fetch(`/api/settings/${cam}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            updateConnectionStatus(true);
            showMessage('Settings saved successfully', 'success');
        } else {
            showMessage(data.message || 'Failed to save settings', 'error');
        }
    })
    .catch(error => {
        updateConnectionStatus(false);
        showMessage('Connection error: ' + error.message, 'error');
    });
}

function pingCamera() {
    fetch(`/api/ping/${cam}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                updateConnectionStatus(true);
                showMessage('Camera is online', 'success');
            } else {
                updateConnectionStatus(false);
                showMessage(data.message || 'Camera not responding', 'error');
            }
        })
        .catch(error => {
            updateConnectionStatus(false);
            showMessage('Connection error: ' + error.message, 'error');
        });
}

// Event listeners
document.getElementById('settings-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings();
});

document.getElementById('reload-btn').addEventListener('click', function() {
    loadSettings();
});

document.getElementById('ping-btn').addEventListener('click', function() {
    pingCamera();
});

// Initial connection test
pingCamera();
</script>
{% endblock %}