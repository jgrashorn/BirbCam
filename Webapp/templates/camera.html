<!DOCTYPE html>
<html>
<head>
  {% block title %}Viewing {{ name }} Â· BirbCam{% endblock %}
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Light/Dark mode (no JS needed) */
    :root {
      --bg: #f6f7f9;
      --surface: #ffffff;
      --text: #1f2328;
      --border: #d0d7de;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0d1117;
        --surface: #0e1420;
        --text: #e6edf3;
        --border: #273242;
      }
    }
    /* Layout + responsive player */
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    }
    .container {
      width: min(1100px, 92vw);
      margin: 0 auto;
      padding: 16px;
    }
    .section-title { margin: 12px 0 8px; font-size: 18px; }
    .player {
      margin-top: 8px;
      background: #000;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px;
    }
    .player video {
      display: block;
      width: 100%;
      height: auto;
      max-height: calc(100vh - 180px); /* keep smaller than viewport */
      object-fit: contain;
      background: #000;
      border-radius: 8px;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .btn {
      display: inline-block;
      text-decoration: none;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
    }
  </style>
  {% block head %}
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  {% endblock %}
</head>
<body>
  {% block content %}
  <div class="container">
    <h1 class="section-title">Live View: {{ name }}</h1>
    <div class="player">
      <video id="video" controls autoplay muted playsinline></video>
    </div>
    <div class="row" style="margin-top:10px">
      <a class="btn" href="/">â¬… Back to dashboard</a>
      <button id="save60" class="btn">ðŸ’¾ Save last 60s</button>
      <span id="saveStatus" class="muted"></span>
    </div>
  </div>
  {% endblock %}

  {% block scripts %}
  <script>
    const url = "{{ stream_url }}";
    const video = document.getElementById('video');
    let hls;

    function attach() {
      if (hls) { try { hls.destroy(); } catch(e) {} }
      if (Hls.isSupported()) {
        hls = new Hls({
          enableWorker: true,
          lowLatencyMode: false,
          // keep your working DVR behavior (no counts mixed in)
          liveSyncDuration: 3,
          liveMaxLatencyDuration: 3600,
          liveSyncDurationCount: undefined,
          liveMaxLatencyDurationCount: undefined,
          maxLiveSyncPlaybackRate: 1.0,
          maxBufferLength: 30,
          manifestLoadingMaxRetry: 10,
          fragLoadingMaxRetry: 10,
          manifestLoadingRetryDelay: 1000,
          fragLoadingRetryDelay: 1000
        });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.ERROR, function (event, data) {
          if (data.fatal) {
            if (data.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
            else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
            else setTimeout(attach, 1000);
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
      }
    }
    attach();

    // Reload if stalled
    let last = 0;
    setInterval(() => {
      if (!video.paused) {
        if (video.currentTime === last) attach();
        last = video.currentTime;
      }
    }, 5000);

    const saveBtn = document.getElementById('save60');
    const saveStatus = document.getElementById('saveStatus');

    async function saveLast(seconds=60) {
      saveBtn.disabled = true;
      saveStatus.textContent = `Saving last ${seconds}s...`;
      try {
        const res = await fetch("/api/clip", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ cam: "{{ name }}", seconds })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "Failed");
        saveStatus.innerHTML = `Saved: <a href="${data.url}" class="btn">${data.filename}</a>`;
      } catch (e) {
        console.error(e);
        saveStatus.textContent = `Error: ${e.message}`;
      } finally {
        saveBtn.disabled = false;
      }
    }
    saveBtn.addEventListener('click', () => saveLast(60));
  </script>
  {% endblock %}
</body>
</html>

